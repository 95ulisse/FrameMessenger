/*! FrameMessenger - v0.1.0 (2014-03-02)
Copyright (c) 2014 Marco Cameriero - Licensed MIT */
!function(a){"object"==typeof module&&"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define([],a):window.FrameMessenger=a()}(function(){"use strict";var ie=function(){var ie=eval("/*@cc_on!@*/false");if(ie){var elem=document.createElement("div");elem.innerHTML='<!--[if IE 7]><div class="ie7"></div><![endif]--><!--[if IE 8]><div class="ie8"></div><![endif]-->',elem.firstChild&&elem.firstChild.className&&(ie=parseInt(elem.firstChild.className.substring(2),10))}return ie}(),Observable=function(){function a(){this._callbacks=[]}return a.prototype.publish=function(a){for(var b=0;b<this._callbacks.length;b++)this._callbacks[b](a)},a.prototype.subscribe=function(a){this._callbacks.push(a)},a.prototype.unsubscribe=function(a){this._callbacks=this._callbacks.filter(function(b){return b!==a})},a}(),Message=function(){function a(a,c,d,e,f){this._messenger=a,this.channel=c,this.data=d,this.id="undefined"==typeof e?b():e,"undefined"!=typeof f&&(this.replyTo=f)}var b=function(){var a=0;return function(){return a++}}();return a.fromJSON=function(b,c){return new a(b,c.channel,c.data,c.id,c.replyTo)},a.prototype.reply=function(c){var d=new a(this._messenger,this.channel,c,b(),this.id);return this._messenger.send(d),d},a.prototype.replied=function(a){return this._messenger._registerMessageReplyCallback(this,a),this},a.prototype.toJSON=function(){return{channel:this.channel,data:this.data,id:this.id,replyTo:this.replyTo}},a}(),FrameMessenger=function(){function a(a,b){var d=location.protocol+"//"+location.host;b=b.toJSON(),c&&(b=JSON.stringify(b)),a.postMessage(b,d)}function b(a){var b=this;b.window=a,b._channels=function(){function a(a){return c[a]||(c[a]=new Observable)}var c={},d=eval.call(null,"this");return d.addEventListener("message",function(c){if(c=c.originalEvent||c,c.origin===location.protocol+"//"+location.host){var d=c.data;"string"==typeof d&&(d=JSON.parse(d)),a(d.channel).publish(Message.fromJSON(b,d))}},!1),a}()}var c="number"==typeof ie&&8>=ie;return b.prototype.stream=function(a,b){this._channels(a).subscribe(function(a){b.call(this,a)}.bind(this))},b.prototype.one=function(a,b){var c=function(d){this._channels(a).unsubscribe(c),b.call(this,d)}.bind(this);this._channels(a).subscribe(c)},b.prototype.send=function(b,c){var d="object"==typeof b?b:new Message(this,b,c);return a(this.window,d),d},b.prototype._registerMessageReplyCallback=function(a,b){var c=a.id,d=function(a){a.replyTo===c&&(this._channels(a.channel).unsubscribe(d),b.call(this,a))}.bind(this);this._channels(a.channel).subscribe(d)},b}();return FrameMessenger});